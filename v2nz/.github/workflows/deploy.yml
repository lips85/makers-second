name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ë°°í¬ ì „ í•„ìˆ˜ ê²€ì¦
  pre-deployment-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    # ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” ìƒíƒœ í™•ì¸ (ë°°í¬ ì „ í•„ìˆ˜)
    - name: ğŸ”’ Pre-deployment schema validation
      run: npm run db:sync-check
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    # E2E í…ŒìŠ¤íŠ¸ (ë°°í¬ ì „ í•„ìˆ˜)
    - name: ğŸ­ Run E2E tests
      run: npm run test:e2e
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

    # ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
    - name: ğŸ›¡ï¸ Security audit
      run: |
        npm audit --audit-level=moderate
        if ! npm audit --audit-level=high; then
          echo "âŒ High severity vulnerabilities found"
          exit 1
        fi

  # Vercel ë°°í¬ (Vercelì˜ GitHub Integration ì‚¬ìš©)
  deploy-vercel:
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    
    steps:
    - name: ğŸš€ Deploy to Vercel
      run: |
        echo "Vercel deployment will be triggered automatically"
        echo "Monitor deployment status in Vercel Dashboard"

  # ë°°í¬ í›„ ê²€ì¦
  post-deployment-checks:
    runs-on: ubuntu-latest
    needs: deploy-vercel
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    # í”„ë¡œë•ì…˜ í™˜ê²½ í—¬ìŠ¤ì²´í¬
    - name: ğŸ¥ Production health check
      run: |
        PRODUCTION_URL="${{ secrets.PRODUCTION_URL || 'https://your-app.vercel.app' }}"
        
        # API ì—”ë“œí¬ì¸íŠ¸ ì²´í¬
        if curl -f -s "$PRODUCTION_URL/api/health" > /dev/null; then
          echo "âœ… Production API is healthy"
        else
          echo "âŒ Production API health check failed"
          exit 1
        fi
        
        # í˜ì´ì§€ ë¡œë”© ì²´í¬
        if curl -f -s "$PRODUCTION_URL" > /dev/null; then
          echo "âœ… Production site is accessible"
        else
          echo "âŒ Production site is not accessible"
          exit 1
        fi

    # ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
    - name: ğŸ’¨ Smoke tests
      run: |
        echo "Running smoke tests against production..."
        # ì—¬ê¸°ì— ì¤‘ìš”í•œ ê¸°ëŠ¥ë“¤ì˜ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì¶”ê°€
        # ì˜ˆ: ë¡œê·¸ì¸, í€´ì¦ˆ ì‹œì‘, ë¦¬ë”ë³´ë“œ ì¡°íšŒ ë“±

  # ìŠ¬ë™ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify:
    runs-on: ubuntu-latest
    needs: [deploy-vercel, post-deployment-checks]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify deployment status
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          ğŸš€ Production Deployment ${{ job.status }}
          
          ğŸ“‹ Summary:
          - Schema validation: ${{ needs.pre-deployment-checks.result }}
          - Vercel deployment: ${{ needs.deploy-vercel.result }}  
          - Health checks: ${{ needs.post-deployment-checks.result }}
          
          ğŸ”— View: ${{ secrets.PRODUCTION_URL }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: env.SLACK_WEBHOOK_URL != ''
