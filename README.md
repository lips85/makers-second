# 프로젝트 분석 보고서: V2NZ - 영어 단어 스피드 퀴즈 (재분석)

이 문서는 `v2nz` 프로젝트에 대한 재분석 결과를 요약합니다. 프로젝트의 구조, 주요 기능, 개선 제안 및 보안 고려사항을 다룹니다.

## 1. 프로젝트 구조 (Project Structure)

`v2nz` 프로젝트는 현대적인 웹 기술 스택을 기반으로 구축된 모노레포 구조의 **Next.js 애플리케이션**입니다. 핵심 로직과 컴포넌트들이 `v2nz` 하위 디렉터리에 집중되어 있습니다.

- **프레임워크**: Next.js 15 (App Router 사용)
- **언어**: TypeScript
- **UI**: TailwindCSS, shadcn/ui, lucide-react
- **상태 관리**: TanStack React Query (`@tanstack/react-query`)
- **백엔드 및 데이터베이스**:
    - **BaaS**: Supabase (PostgreSQL, Authentication, Storage)
    - **ORM**: Drizzle ORM
    - **데이터베이스 스크립팅**: `tsx`를 활용한 TypeScript 스크립트 (`scripts/`)
- **배포**: Vercel

### 주요 디렉터리 구조

```
v2nz/
├── src/
│   ├── app/         # Next.js App Router: 페이지 및 API 라우트
│   ├── components/  # 재사용 가능한 React 컴포넌트
│   ├── db/          # Drizzle 스키마, 마이그레이션, RLS 정책
│   ├── lib/         # 핵심 유틸리티, Supabase 클라이언트, 환경 변수 관리
│   └── hooks/       # 커스텀 React Hooks
├── supabase/        # Supabase 마이그레이션 SQL 파일
├── scripts/         # 데이터베이스 시딩 및 정책 적용 스크립트
└── public/          # 정적 에셋
```

### 개발 워크플로
- `package.json`에 정의된 스크립트 (`db:migrate`, `db:seed`, `db:check` 등)를 통해 데이터베이스 스키마 관리, 마이그레이션, 시딩이 자동화되어 있어 개발 효율성이 높습니다.
- Drizzle Kit을 사용하여 스키마 변경 사항을 관리하고, `tsx`로 작성된 스크립트를 통해 RLS 정책을 일관되게 적용하는 등 체계적인 데이터베이스 관리 워크플로를 갖추고 있습니다.

## 2. 기능 구성 (Features)

이 애플리케이션은 학생들이 영어 단어를 학습하고 경쟁할 수 있는 게임 형태의 플랫폼입니다.

- **핵심 게임 루프**:
    - 정해진 시간 (60~90초) 동안 단어 퀴즈를 푸는 라운드 기반 게임.
    - 점수는 **정확도**와 **속도**를 조합하여 계산됩니다.
    - 클라이언트에서 계산된 점수를 서버에서 재검증하여 데이터 무결성을 보장합니다.

- **사용자 관리**:
    - **일반 사용자**: 이메일/패스워드 또는 소셜 로그인을 통한 가입 및 인증 (Supabase Auth).
    - **게스트 사용자**: 회원가입 없이 즉시 게임을 체험할 수 있는 기능. 게스트 데이터는 나중에 정식 계정으로 통합될 수 있습니다.

- **리더보드 및 동기부여**:
    - 일간/주간/월간 리더보드를 통해 사용자 순위를 제공합니다.
    - 개인의 성과를 백분위 (Percentile) 및 스타나인 (Stanine) 점수로 시각화하여 학습 동기를 부여합니다.
    - 조직(학교/학급) 단위의 대항전 기능이 계획되어 있습니다.

- **교사 및 학급 관리**:
    - 교사는 '교실 코드'를 발급하여 학생들을 자신의 조직에 소속시킬 수 있습니다.
    - 교사 계정은 소속 학생들의 학습 데이터를 열람할 수 있는 권한을 가집니다 (RLS 정책으로 통제).
    - 교실 코드 입력 시 학생들에게는 배너 광고가 숨김 처리되어 학습 경험을 개선합니다.

## 3. 개선 필요 사항 (Areas for Improvement)

- **게스트 사용자 관리 로직 개선**:
    - `upgrade_guest_to_user` SQL 함수는 여러 게스트가 동시에 존재할 경우, 의도치 않은 데이터 병합이 발생할 수 있는 잠재적 위험이 있습니다. `WHERE` 절을 특정 게스트 ID를 지정하도록 수정해야 합니다.
    - 비활성 게스트 계정을 주기적으로 삭제하는 백그라운드 작업(Cron Job)을 추가하여 데이터베이스 테이블이 불필요하게 커지는 것을 방지해야 합니다.

- **코드 리팩토링**:
    - `upgrade_guest_to_user` 함수 내에서 `rounds`와 `leaderboards` 테이블을 업데이트하는 로직이 중복됩니다. 이를 단일 함수나 프로시저로 통합하여 코드의 재사용성을 높일 수 있습니다.
    - `submitRound` API 라우트의 멱등성(Idempotency) 처리가 현재는 인메모리 `Set`으로 구현되어 있습니다. 운영 환경에서는 서버가 여러 인스턴스로 확장될 경우를 대비해 Redis나 데이터베이스 기반의 분산 잠금 메커니즘으로 교체하는 것을 권장합니다.

- **테스트 커버리지 확대**:
    - `submitRound` API에 대한 테스트 파일 (`route.test.ts`)이 존재하지만, 다른 중요한 API 라우트(예: `generateCode`, `joinCode`)에 대한 테스트 케이스가 부족합니다. 핵심 로직에 대한 통합 테스트를 추가하여 안정성을 높여야 합니다.

- **CORS 정책 구체화**:
    - `submitRound` 라우트의 `OPTIONS` 핸들러에서 `Access-Control-Allow-Origin`이 와일드카드(`*`)로 설정되어 있습니다. 프로덕션 환경에서는 보안을 위해 허용된 프론트엔드 도메인으로 제한하는 것이 좋습니다.

## 4. 보안상 보완점 (Security Considerations)

프로젝트는 전반적으로 우수한 보안 관행을 따르고 있으나, 몇 가지 추가적인 강화 조치를 통해 더 안전하게 만들 수 있습니다.

- **강점**:
    - **RLS (Row-Level Security)**: Supabase의 RLS가 적극적으로 사용되어 사용자가 자신의 데이터나 소속된 조직의 데이터에만 접근하도록 통제합니다. 이는 멀티테넌트 애플리케이션의 핵심적인 보안 요구사항을 충족합니다.
    - **서버 사이드 검증**: `submitRound` API에서 클라이언트가 보낸 게임 결과를 서버에서 재검증하는 로직이 구현되어 있어 점수 조작과 같은 부정행위를 방지합니다.
    - **환경 변수 관리**: Zod를 사용하여 환경 변수를 검증하므로, 설정 오류로 인한 런타임 문제를 예방합니다.
    - **SQL 함수 활용**: 비즈니스 로직을 데이터베이스 함수 (`SECURITY DEFINER` 사용) 내에 캡슐화하여 API 서버와 데이터베이스 간의 상호작용을 최소화하고 보안을 강화합니다.

- **보완 제안**:
    - **API 속도 제한 (Rate Limiting)**: 인증 관련 엔드포인트 (`/api/auth/guest`, `/api/auth/upgrade-guest`) 및 코드 생성 API에 속도 제한을 적용하여 무차별 대입 공격(Brute-force)이나 서비스 남용을 방지해야 합니다.
    - **게스트 계정 업그레이드 보안**: 앞서 언급했듯이, 게스트 계정을 정식 계정으로 전환하는 프로세스는 특정 게스트를 고유하게 식별할 수 있는 토큰이나 ID를 사용하도록 수정하여 데이터 무결성을 보장해야 합니다.
    - **오류 메시지 로깅**: 현재 개발 환경에서만 상세한 오류 메시지를 반환하는 것은 좋은 관행입니다. 프로덕션 환경에서는 민감한 정보가 노출되지 않도록 일반적인 메시지를 반환하되, 상세한 오류 내용은 서버 측 로깅 시스템(예: Sentry, Datadog)에 기록하여 추적할 수 있도록 구성하는 것이 좋습니다.
    - **의존성 관리**: 정기적으로 `npm audit`을 실행하여 알려진 보안 취약점이 있는 패키지를 최신 버전으로 업데이트해야 합니다.
